#-----------------------------------------------------------------------------#
#                                                                             #
# SCRIPTS PARA APAGADO Y ENCENDIDO GENERAL DE LA CASA                         #
#                                                                             #
#-----------------------------------------------------------------------------#
home_switch_off:
  alias: 'Home Total Switch Off'
  sequence:
    # APAGADO LUCES LIGHT
    - service: light.turn_off
      entity_id: group.luces_interior_grp

    # APAGADO LUCES JARDIN EXCEPTO FAROLES EXTERIOR (TODAS TIPO SWITCH)
    - service: switch.turn_off
      entity_id: group.luces_jardin_grp

    # APAGADO LUCES JARDIN EXCEPTO FAROLES EXTERIOR (TODAS TIPO SWITCH)
    - service: switch.turn_off
      entity_id: group.switch_calefaccion_grp

alarma_to_pending:
  alias: "Alarma Disarmed to Pending"
  sequence:
    - condition: template
      value_template: '{{fromstate != tostate}}'

    # Aviso sonoro con Xiaomi GW
    - service: xiaomi_aqara.stop_ringtone
      data:
        gw_mac: !secret xiaomi_mac
    - service: xiaomi_aqara.play_ringtone
      data_template:
        gw_mac: !secret xiaomi_mac
        ringtone_id: '{{ringtone_msg}}'
        ringtone_vol: >
          {{ states('input_number.xiaomi_volume_alarm_armed') | int }}

# SCRIPT PARA NOTIFICACION MENSAJES SONORO SISTEMA ARMADO
#
# {{ states.input_select.xiaomi_sound_alarm_armed.state.split('-')[0] }}
# {{ states('input_number.xiaomi_volume_alarm_armed') | int }}
#
sirena_xiaomi_play_alarm_armed:
  alias: "Alarma Sonido Armado"
  sequence:
    # IF Mute_Xiaomi = ON => True => CANCEL SCRIPT
    - condition: template
      value_template: "{% if is_state('input_boolean.mute_sonido_sirenas', 'off') %}true{% endif %}"
    # Aviso Xiaomi GW
    - service: xiaomi_aqara.stop_ringtone
      data:
        gw_mac: !secret xiaomi_mac
    - service: xiaomi_aqara.play_ringtone
      data_template:
        gw_mac: !secret xiaomi_mac
        ringtone_id: >-
            {{ states.input_select.xiaomi_sound_alarm_armed.state.split('-')[0] }}
        ringtone_vol: >-
            {{ states('input_number.xiaomi_volume_alarm_armed') | int }}

sirena_xiaomi_play_alarm_disarmed:
  alias: "Alarma Sonido Desarmado"
  sequence:
    # IF Mute_Xiaomi = ON => True => CANCEL SCRIPT
    - condition: template
      value_template: "{% if is_state('input_boolean.mute_sonido_sirenas', 'off') %}true{% endif %}"
    # SONOFF_SW1_SIRENA INTERIOR ==> OFF
    #- service: switch.turn_off
    #  entity_id: switch.esphome_bas_sw0

    # Aviso Xiaomi GW
    - service: xiaomi_aqara.stop_ringtone
      data:
        gw_mac: !secret xiaomi_mac
    - service: xiaomi_aqara.play_ringtone
      data_template:
        gw_mac: !secret xiaomi_mac
        ringtone_id: >-
            {{ states.input_select.xiaomi_sound_alarm_disarmed.state.split('-')[0] }}
        ringtone_vol: >-
            {{ states('input_number.xiaomi_volume_alarm_disarmed') | int }}

# SCRIPT PARA ENCENDER SIRENAS INTERIOR TRAS DISPARO DE ALARMA
#
# {{ states.input_select.xiaomi_sound_alarm.state.split('-')[0] }}
# {{ states('input_number.xiaomi_volume_alarm') | int }}
#
sirena_v0_alarma_armed_away:
  alias: "Sirena Alarma Armed Away"
  sequence:
    # IF Mute_Xiaomi = ON => True => CANCEL SCRIPT
    - condition: template
      value_template: "{% if is_state('input_boolean.mute_sonido_sirenas', 'off') %}true{% endif %}"
    - service: xiaomi_aqara.stop_ringtone
      data:
        gw_mac: !secret xiaomi_mac
    - service: xiaomi_aqara.play_ringtone
      data_template:
        gw_mac: !secret xiaomi_mac
        ringtone_id: >-
            {{ states.input_select.xiaomi_sound_alarm.state.split('-')[0] }}
        ringtone_vol: >-
            {{ states('input_number.xiaomi_volume_alarm') | int}}
    # Retraso 5"
    - delay: '00:00:05'
    #######################################
    #  SONOFF_SW1_SIRENA INTERIOR ==> ON  #
    #######################################
    - service: switch.turn_on
      entity_id: switch.esphome_bas_sw0

# SCRIPT PARA ENCENDER SOLO SIRENA XIAOMI TRAS DISPARO
# DE ALARMA ARMED HOME O SENSOR DE HUMO
#
sirena_v0_alarma_armed_home:
  alias: "Sirena Alarma Armed Home"
  sequence:
    # IF Mute_Xiaomi = ON => True => CANCEL SCRIPT
    - condition: template
      value_template: "{% if is_state('input_boolean.mute_sonido_sirenas', 'off') %}true{% endif %}"
    - service: xiaomi_aqara.stop_ringtone
      data:
        gw_mac: !secret xiaomi_mac
    - service: xiaomi_aqara.play_ringtone
      data_template:
        gw_mac: !secret xiaomi_mac
        ringtone_id: >-
            {{ states.input_select.xiaomi_sound_alarm.state.split('-')[0] }}
        ringtone_vol: >-
            {{ states('input_number.xiaomi_volume_alarm') | int}}


# SCRIPT PARA NOTIFICACION MENSAJES SONORO SISTEMA ARMADO
#
sirena_stop_alarma:
  alias: "Botón Stop Sirenas"
  sequence:
    # SONOFF_SW1_SIRENA INTERIOR ==> OFF
    - service: switch.turn_off
      entity_id: switch.esphome_bas_sw0
    # Aviso Xiaomi GW
    - service: xiaomi_aqara.stop_ringtone
      data:
        gw_mac: !secret xiaomi_mac


# SCRIPT PARA UN MICRO AVISO DE SIRENA INTERIOR
#
#  SONOFF_SW1_SIRENA INTERIOR ==> ON  #
sirena_alarma_micro_aviso:
  alias: "Sirena Alarma Warning"
  sequence:
    # IF Mute Sonido Sirenas = ON => True => CANCEL SCRIPT
    - condition: template
      value_template: "{% if is_state('input_boolean.mute_sonido_sirenas', 'off') %}true{% endif %}"
    #
    # CICLO 1:
    - service: switch.turn_on
      entity_id: switch.esphome_bas_sw0
    - delay:
        milliseconds: 50
    - service: switch.turn_off
      entity_id: switch.esphome_bas_sw0

# SCRIPT PARA ENCENDER SIRENAS INTERIOR TRAS PULSAR EL DOBLE BOTON PANICO DESDE APP HOMY IOS
#
# La secuencia requerida es:
# 1. Activar la "llave del botón pánico" con el interruptor: input_boolean.panic_button
# 2. Pulsar el botón de ESTE script publicado en el frontend: script.alarma_boton_panico
# 3. Pulsar el botón del script de apagado para cancelar sirenas: script.boton_panico
#
# Las sirenas se activan en este orden:
# 1. Sirena interior Xiaomi con el tono configurado para Alarma
# 2. Retraso de 5 segundos
# 3. Sirena interior pasillo mediante switch.esphome_bas_sw0

alarma_boton_panico:
  alias: 'Boton Panico ON'
  sequence:
    # When a condition does not return true, the script will finish
    - condition: template
      value_template: "{% if is_state('input_boolean.panic_button', 'on') %}true{% endif %}"
    # Llamada Scripts SIRENAS ALARMA
    - service: script.sirena_alarma
    # Notifica Telegram
    - service: script.notifica_evento
      data:
        titulo: '*ALARMA HOMY*'
        mensaje: >
          >>> URGENTE: BOTON PANICO ACTIVADO

alarma_boton_panico_off:
  alias: 'Boton Panico OFF'
  sequence:
    # Llamada Scripts STOP SIRENAS ALARMA
    - service: script.sirena_stop_alarma
    # Notifica Telegram
    - service: script.notifica_evento
      data:
        titulo: '*ALARMA HOMY*'
        mensaje: >
          >>> URGENTE: BOTON PANICO DESACTIVADO

#
# SCRIPTS PARA GESTION ALARMA DESDE ALEXA
#
homy_armado_parcial:
  alias: 'Homy Armado Parcial'
  sequence:
    # When a condition does not return true, the script will finish
    - condition: template
      value_template: "{% if not is_state('alarm_control_panel.ha', 'armed_home') %}true{% endif %}"
    - service: alarm_control_panel.alarm_arm_home
      entity_id: alarm_control_panel.ha
    # La notificación se hace mediente la activación de la regla:
    # alias: 'A2 Alarm Armed Away'

homy_armado_total:
  alias: 'Homy Armado Total'
  sequence:
    # When a condition does not return true, the script will finish
    - condition: template
      value_template: "{% if not is_state('alarm_control_panel.ha', 'armed_away') %}true{% endif %}"
    - service: alarm_control_panel.alarm_arm_away
      entity_id: alarm_control_panel.ha
    # La notificación se hace mediente la activación de la regla:
    # alias: 'A2 Alarm Armed Away'

homy_desarmado_code:
  alias: 'Homy Desarmado'
  sequence:
    - service: alarm_control_panel.alarm_disarm
      entity_id: alarm_control_panel.ha
      data:
        code: !secret alarm_control_code
    # La notificación se hace mediente la activación de la regla:
    # alias: 'A4_alarma_activa_desarmada'

#-----------------------------------------------------------------------------#
#                                                                             #
# SCRIPTS PARA ENCENDER SIRENAS INTERIOR TRAS DISPARO DE ALARMA               #
#                                                                             #
#-----------------------------------------------------------------------------#

sirena_alarma_triggered:
  alias: "Sirena Alarma Triggered"
  mode: restart
  sequence:
    # IF Mute Sirenas = ON => True => CANCEL SCRIPT
    - condition: template
      value_template: "{% if is_state('input_boolean.mute_sonido_sirenas', 'off') %}true{% endif %}"

    #- service: xiaomi_aqara.play_ringtone
    #  data_template:
    #    gw_mac: !secret xiaomi_mac
    #    ringtone_id: >-
    #        {{ states.input_select.xiaomi_sound_alarm.state.split('-')[0] }}
    #    ringtone_vol: >-
    #        {{ states('input_number.xiaomi_volume_alarm') | int}}

    # Retraso 5"
    - delay: '00:00:05'
    #######################################
    #  SONOFF_SW1_SIRENA INTERIOR ==> ON  #
    #######################################
    - service: switch.turn_on
      entity_id: switch.esphome_bas_sw0

#-----------------------------------------------------------------------------#
#                                                                             #
# SCRIPTS GENERICOS DE MEDIA_PLAYER ALEXA Y FIRETV                            #
#                                                                             #
#-----------------------------------------------------------------------------#

# Script  para establecer el  volumen de voz a Alexa DORMITORIO / ENTRADA / ESTUDIO segun la hora
#
alexa_dormitorio_set_volumen:
  alias: 'Alexa Dormitorio Set Vol'
  mode: restart
  sequence:
    # Almacena y Ajusta el Volumen Alexa Dormitorio según hora
    - service: input_number.set_value
      data_template:
        entity_id: input_number.alexa_dormitorio_volumen_nuevo
        value: >
          {% if now().hour >= 0 and now().hour <= 9 %}
            {{ states('input_number.alexa_dormitorio_volumen_anuncio_noc')|float }}
          {% else %}
            {{ states('input_number.alexa_dormitorio_volumen_anuncio_dia')|float }}
          {%endif%}
    # Establece el volumen
    - service: media_player.volume_set
      data_template:
        entity_id: media_player.echo_alexa_dormitorio
        volume_level: "{{ states('input_number.alexa_dormitorio_volumen_nuevo')|float }}"
    - service: media_player.volume_set
      data_template:
        entity_id: media_player.echo_alexa_dormitorio_aac
        volume_level: "{{ states('input_number.alexa_dormitorio_volumen_nuevo')|float }}"

alexa_entrada_set_volumen:
  alias: 'Alexa Entrada Set Vol'
  mode: restart
  sequence:
    # Almacena y Ajusta el Volumen Alexa ENTRADA según hora
    - service: input_number.set_value
      data_template:
        entity_id: input_number.alexa_entrada_volumen_nuevo
        value: >
          {% if now().hour >= 0 and now().hour <= 9 %}
            {{ states('input_number.alexa_entrada_volumen_anuncio_noc')|float }}
          {% else %}
            {{ states('input_number.alexa_entrada_volumen_anuncio_dia')|float }}
          {%endif%}
    # Establece el volumen
    - service: media_player.volume_set
      data_template:
        entity_id: media_player.echo_alexa_entrada
        volume_level: "{{ states('input_number.alexa_entrada_volumen_nuevo')|float }}"

alexa_estudio_set_volumen:
  alias: 'Alexa Estudio Set Vol'
  mode: restart
  sequence:
    # Almacena y Ajusta el Volumen Alexa ESTUDIO según hora
    - service: input_number.set_value
      data_template:
        entity_id: input_number.alexa_estudio_volumen_nuevo
        value: >
          {% if now().hour >= 0 and now().hour <= 9 %}
            {{ states('input_number.alexa_estudio_volumen_anuncio_noc')|float }}
          {% else %}
            {{ states('input_number.alexa_estudio_volumen_anuncio_dia')|float }}
          {%endif%}
    # Establece el volumen
    - service: media_player.volume_set
      data_template:
        entity_id: media_player.echo_alexa_estudio
        volume_level: "{{ states('input_number.alexa_estudio_volumen_nuevo')|float }}"

# Script completo para almacenar el volumen actual y establecer el volumen de voz a Alexa DORMITORIO
#
#
alexa_dormitorio_set_volumen_alarma:
  alias: 'Alexa Dormitorio Set Vol Alarma'
  mode: restart
  sequence:
    # Almacena el Volumen Actual de Alexa Dormitorio
    - service: input_number.set_value
      data_template:
        entity_id: input_number.alexa_dormitorio_volumen_anterior
        value: "{{ states.media_player.echo_alexa_dormitorio.attributes.volume_level|float }}"
    # Almacena y Ajusta el Volumen Alexa Dormitorio según tipo mensaje-hora
    - service: input_number.set_value
      data_template:
        entity_id: input_number.alexa_dormitorio_volumen_nuevo
        value: >
          {% if states.alarm_control_panel.ha.state == 'triggered' and now().hour >= 0 and now().hour <= 9 %}
            {{ states('input_number.alexa_dormitorio_volumen_alarma_noc')|float }}
          {% elif states.alarm_control_panel.ha.state == 'triggered' and now().hour >= 10 and now().hour <= 23 %}
            {{ states('input_number.alexa_dormitorio_volumen_alarma_dia')|float  }}
          {% elif states.alarm_control_panel.ha.state != 'triggered' and now().hour >= 0 and now().hour <= 9 %}
            {{ states('input_number.alexa_dormitorio_volumen_anuncio_noc')|float  }}
          {% elif states.alarm_control_panel.ha.state != 'triggered' and now().hour >= 10 and now().hour <= 23 %}
            {{ states('input_number.alexa_dormitorio_volumen_anuncio_dia')|float  }}
          {%endif%}
    # Establece el volumen
    - service: media_player.volume_set
      data_template:
        entity_id: media_player.echo_alexa_dormitorio
        volume_level: "{{ states('input_number.alexa_dormitorio_volumen_nuevo')|float }}"

#
# Script completo para almacenar el volumen actual y establecer el volumen de voz a Alexa ENTRADA
#
#
alexa_entrada_set_volumen_alarma:
  alias: 'Alexa Entrada Set Vol Alarma'
  mode: restart
  sequence:
    # Almacena el Volumen Actual de Alexa Entrada
    - service: input_number.set_value
      data_template:
        entity_id: input_number.alexa_entrada_volumen_anterior
        value: "{{ states.media_player.echo_alexa_entrada.attributes.volume_level|float }}"
    # Almacena y Ajusta el Volumen Alexa entrada según tipo mensaje-hora
    - service: input_number.set_value
      data_template:
        entity_id: input_number.alexa_entrada_volumen_nuevo
        value: >
          {% if states.alarm_control_panel.ha.state == 'triggered' and now().hour >= 0 and now().hour <= 9 %}
            {{ states('input_number.alexa_entrada_volumen_alarma_noc') }}
          {% elif states.alarm_control_panel.ha.state == 'triggered' and now().hour >= 10 and now().hour <= 23 %}
            {{ states('input_number.alexa_entrada_volumen_alarma_dia') }}
          {% elif states.alarm_control_panel.ha.state != 'triggered' and now().hour >= 0 and now().hour <= 9 %}
            {{ states('input_number.alexa_entrada_volumen_anuncio_noc') }}
          {% elif states.alarm_control_panel.ha.state != 'triggered' and now().hour >= 10 and now().hour <= 23 %}
            {{ states('input_number.alexa_entrada_volumen_anuncio_dia') }}
          {%endif%}
    # Establece el volumen
    - service: media_player.volume_set
      data_template:
        entity_id: media_player.echo_alexa_entrada
        volume_level: "{{ states('input_number.alexa_entrada_volumen_nuevo')|float }}"

#
# Scripts básicos para restaurar el volumen original que tenía Alexa antes del mensaje
#
alexa_entrada_restaura_volumen:
  alias: 'Alexa Entrada Restaura Vol'
  mode: restart
  sequence:
    # Restablece el Volumen Anterior al mensaje
    - service: media_player.volume_set
      data_template:
        entity_id: media_player.echo_alexa_entrada
        volume_level: "{{ states('input_number.alexa_entrada_volumen_anterior')|float }}"

alexa_dormitorio_restaura_volumen:
  alias: 'Alexa Dormitorio Restaura Vol'
  mode: restart
  sequence:
    # Restablece el Volumen Anterior al mensaje
    - service: media_player.volume_set
      data_template:
        entity_id: media_player.echo_alexa_dormitorio
        volume_level: "{{ states('input_number.alexa_dormitorio_volumen_anterior')|float }}"

#
# Script completo para enviar un SONIDO varias repeticiones a un Alexa
#
# Parámetros:
# alexa:      nombre del dispositivo de salida:  entrada/dormitorio.
# sonido:     nombre del sonido de Amazon Alexa.
# repeticion: numero de repeticiones
#
alexa_sonido_alarma:
  alias: 'Alexa Sonido Alarma'
  mode: restart
  sequence:
    - repeat:
        count: "{{ repeticion|int }}"
        sequence:
          - service: media_player.play_media
            data_template:
              entity_id: "media_player.echo_alexa_{{ alexa }}"
              media_content_type: sound
              media_content_id: "{{ sonido }}"

#
# Script completo para enviar un SONIDO DE ALARMA mientras TRIGGERED a todos los Alexa
#
# Parámetros:
# sonido:     nombre del sonido de Amazon Alexa.
#
alexa_sirena_alarma:
  alias: 'Alex Sirena Alarma'
  mode: restart
  sequence:
    - repeat:
        while:
          - condition: state
            entity_id: alarm_control_panel.ha
            state: 'triggered'
            # value_template: "{{ states.alarm_control_panel.ha.state == 'triggered' }}"
        sequence:
          - service: media_player.play_media
            data_template:
              entity_id:
                - media_player.echo_alexa_entrada
                - media_player.echo_alexa_dormitorio
              media_content_type: sound
              media_content_id: "{{ sonido }}"
          - delay: 00:00:03

#
# Script genérico y básico para enviar un mensaje de voz a un Alexa Echo
#
# Parámetros:
# alexa:    nombre del dispositivo destino:  entrada / dormitorio
# titulo:   titulo del mensaje (de momento solo valido para echo show)
# voz:      mensaje de voz
#
alexa_anuncio:
  alias: 'Alexa Mensaje Voz'
  mode: restart
  sequence:
    # envio mensaje voz
    - service: notify.alexa_media
      data_template:
        target: "media_player.echo_alexa_{{ alexa }}"
        title: "{{ titulo }}"
        message: "{{ voz }}"
        data:
          type: announce
#
# Script genérico y básico para enviar un mensaje de voz a un Alexa Echo
#
# Parámetros:
# alexa:    nombre del dispositivo destino:  entrada / dormitorio
# sonido:   nombre del sonido a reproducir.  Ver https://github.com/custom-components/alexa_media_player/wiki#examples
#
alexa_sonido:
  alias: 'Alexa Sonido'
  mode: restart
  sequence:
    # Envio Sonido
    - service: media_player.play_media
      data_template:
        entity_id: "media_player.echo_alexa_{{ alexa }}"
        media_content_type: sound
        media_content_id: "{{ sonido }}"

#
# Script completo para enviar un mensaje de voz y sonido Alarma a ALEXA
# En función de la entidad input_select.alarma_media_player, se enviará al media player seleccionado.
#
# Parámetros:
# voz:        mensaje de voz
# sonido:     nombre del sonido a reproducir.  Ver https://github.com/custom-components/alexa_media_player/wiki#examples
# repeticion: numero de repeticiones
#
alexa_secuencia:
  alias: 'Alexa Secuencia'
  mode: restart
  sequence:
    - choose:
        # Opciones echo_alexa_entrada, echo alexa_dormitorio
        - conditions:
            - condition: state
              entity_id: input_select.alarma_media_player
              state: 'media_player.echo_alexa_dormitorio'
          sequence:
            - service: script.alexa_dormitorio_set_volumen_alarma
            - service: script.alexa_anuncio
              data_template:
                alexa: 'dormitorio'
                voz: "{{ voz }}"
            - service: script.alexa_sonido_alarma
              data_template:
                alexa: 'dormitorio'
                sonido: "{{ sonido }}"
                repeticion: "{{ repeticion }}"
            - delay: 00:00:10
            - service: script.alexa_dormitorio_restaura_volumen
      default:
        # SALIDA ALEXA ENTRADA
        - service: script.alexa_entrada_set_volumen_alarma
        - service: script.alexa_anuncio
          data_template:
            alexa: 'entrada'
            voz: "{{ voz }}"
        - service: script.alexa_sonido_alarma
          data_template:
            alexa: 'entrada'
            sonido: "{{ sonido }}"
            repeticion: "{{ repeticion }}"
        - delay: 00:00:10
        - service: script.alexa_entrada_restaura_volumen

#
# Script completo para enviar un mensaje de voz y sonido Alarma a ALEXA ENTRADA
#
# Parámetros:
# voz:        mensaje de voz
# sonido:     nombre del sonido a reproducir.  Ver https://github.com/custom-components/alexa_media_player/wiki#examples
# repeticion: numero de repeticiones
#
alexa_entrada_secuencia:
  alias: 'Alexa Entrada Secuencia'
  mode: restart
  sequence:
    - service: script.alexa_entrada_set_volumen_alarma
    - service: script.alexa_anuncio
      data_template:
        alexa: 'entrada'
        voz: "{{ voz }}"
    - service: script.alexa_sonido_alarma
      data_template:
        alexa: 'entrada'
        sonido: "{{ sonido }}"
        repeticion: "{{ repeticion }}"
    - delay: 00:00:10
    - service: script.alexa_entrada_restaura_volumen

alexa_dormitorio_secuencia:
  alias: 'Alexa Dormitorio Secuencia'
  mode: restart
  sequence:
    - service: script.alexa_dormitorio_set_volumen_alarma
    - service: script.alexa_anuncio
      data_template:
        alexa: 'dormitorio'
        voz: "{{ voz }}"
    - service: script.alexa_sonido_alarma
      data_template:
        alexa: 'dormitorio'
        sonido: "{{ sonido }}"
        repeticion: "{{ repeticion }}"
    - delay: 00:00:10
    - service: script.alexa_dormitorio_restaura_volumen

#
# Script completo para enviar un sonido de cuenta atrás durante el proceso de ARMADO
# Alexa estará tocando el sonido desarmado mientras el estado de alarma sea ARMING
#
# Parámetros:
# voz:        mensaje de voz
# sonido:     nombre del sonido de Amazon Alexa.
#
alexa_secuencia_alarma_armado:
  alias: 'Alexa Secuencia Alarma Armado'
  mode: restart
  sequence:
    - choose:
        # Opciones echo_alexa_entrada, echo alexa_dormitorio
        - conditions:
            - condition: state
              entity_id: input_select.alarma_media_player
              state: 'media_player.echo_alexa_dormitorio'
          sequence:
            - service: script.alexa_dormitorio_set_volumen_alarma
            - service: script.alexa_anuncio
              data_template:
                alexa: 'dormitorio'
                voz: "{{ voz }}"
            - repeat:
                while:
                  - condition: state
                    entity_id: alarm_control_panel.ha
                    state: 'arming'
                    #  value_template: "{{ states.alarm_control_panel.ha.state == 'arming' }}"
                sequence:
                  - service: media_player.play_media
                    data_template:
                      entity_id: '{{ states.input_select.alarma_media_player.state }}'
                      media_content_type: sound
                      media_content_id: "{{ sonido }}"
                  - delay: 00:00:03
            - delay: 00:00:10
            - service: script.alexa_dormitorio_restaura_volumen
      default:
        - service: script.alexa_entrada_set_volumen_alarma
        - service: script.alexa_anuncio
          data_template:
            alexa: 'entrada'
            voz: "{{ voz }}"
        - repeat:
            while:
              - condition: state
                entity_id: alarm_control_panel.ha
                state: 'arming'
                #  value_template: "{{ states.alarm_control_panel.ha.state == 'arming' }}"
            sequence:
              - service: media_player.play_media
                data_template:
                  entity_id: '{{ states.input_select.alarma_media_player.state }}'
                  media_content_type: sound
                  media_content_id: "{{ sonido }}"
              - delay: 00:00:03
    - delay: 00:00:10
    - service: script.alexa_entrada_restaura_volumen

# Script completo para enviar un sonido de cuenta atrás durante el proceso de DESARMADO
# Alexa estará tocando el sonido desarmado mientras el estado de alarma sea PENDING
#
# Parámetros:
# voz:        mensaje de voz
# sonido:     nombre del sonido de Amazon Alexa.
#
alexa_secuencia_alarma_desarmado:
  alias: 'Alexa Secuencia Alarma Desrmado'
  mode: restart
  sequence:
    - choose:
        # Opciones echo_alexa_entrada, echo alexa_dormitorio
        - conditions:
            - condition: state
              entity_id: input_select.alarma_media_player
              state: 'media_player.echo_alexa_dormitorio'
          sequence:
            - service: script.alexa_dormitorio_set_volumen_alarma
            - service: script.alexa_anuncio
              data_template:
                alexa: 'dormitorio'
                voz: "{{ voz }}"
            - repeat:
                while:
                  - condition: state
                    entity_id: alarm_control_panel.ha
                    state: 'pending'
                    #value_template: "{{ states.alarm_control_panel.ha.state == 'pending' }}"
                sequence:
                  - service: media_player.play_media
                    data_template:
                      entity_id: '{{ states.input_select.alarma_media_player.state }}'
                      media_content_type: sound
                      media_content_id: "{{ sonido }}"
                  - delay: 00:00:03
            - delay: 00:00:10
            - service: script.alexa_dormitorio_restaura_volumen
      default:
        - service: script.alexa_entrada_set_volumen_alarma
        - service: script.alexa_anuncio
          data_template:
            alexa: 'entrada'
            voz: "{{ voz }}"
        - repeat:
            while:
              - condition: state
                entity_id: alarm_control_panel.ha
                state: 'pending'
                #value_template: "{{ states.alarm_control_panel.ha.state == 'pending' }}"
            sequence:
              - service: media_player.play_media
                data_template:
                  entity_id: '{{ states.input_select.alarma_media_player.state }}'
                  media_content_type: sound
                  media_content_id: "{{ sonido }}"
              - delay: 00:00:03
        - delay: 00:00:10
        - service: script.alexa_entrada_restaura_volumen
#
# Script completo para enviar un sonido de cuenta atrás durante el proceso de armado o desarmado
# Alexa estará tocando el sonido desarmado mientras el estado de alarma sea TRIGGERED
#
# Parámetros:
# voz:        mensaje de voz
# sonido:     nombre del sonido de Amazon Alexa.
#
alexa_secuencia_alarma_disparada:
  alias: 'Alexa Secuencia Alarma Disparada'
  mode: restart
  sequence:
    - service: script.alexa_entrada_set_volumen_alarma
    - service: script.alexa_dormitorio_set_volumen_alarma
    - service: media_player.play_media
      data_template:
        entity_id:
          - media_player.echo_alexa_entrada
          - media_player.echo_alexa_dormitorio
        media_content_type: sound
        media_content_id: "{{ states('input_select.alarma_sonido_disparado') }}"
    # RETRASO DE 3 SEGUNDOS "
    - delay: 00:00:03
    #######################################
    # SONOFF_SW1_SIRENA INTERIOR ==> ON
    #######################################
    - service: switch.turn_on
      entity_id: switch.esphome_bas_sw0
    #
    # Bucle sirena Alexa mientras la alarma esté disparada.
    - repeat:
        while:
          - condition: state
            entity_id: alarm_control_panel.ha
            state: 'triggered'
            #value_template: "{{ states.alarm_control_panel.ha.state == 'triggered' }}"
        sequence:
          - service: media_player.play_media
            data_template:
              entity_id:
                - media_player.echo_alexa_entrada
                - media_player.echo_alexa_dormitorio
              media_content_type: sound
              media_content_id: "{{ states('input_select.alarma_sonido_disparado') }}"
          - delay: 00:00:03
    #######################################
    # SONOFF_SW1_SIRENA INTERIOR ==> OFF
    #######################################
    - service: switch.turn_off
      entity_id: switch.esphome_bas_sw0
    - delay: 00:00:10
    - service: script.alexa_entrada_restaura_volumen
    - service: script.alexa_dormitorio_restaura_volumen

#
#---------------------------- PRUEBAS ------------------------
#
test_alexa_secuencia_armado:
  alias: 'Test Alexa Secuencia Alarma Armado'
  mode: restart
  sequence:
    - service: light.turn_on
      entity_id: light.luz_vitrina
    - service: script.alexa_dormitorio_secuencia
      data_template:
        voz: 'ATENCION!. Luz Vitrina Entendida'
        sonido: "{{ states('input_select.alarma_sonido_armado') }}"
        repeticion: 1
    - repeat:
        while:
          - condition: state
            entity_id: light.luz_vitrina
            state: 'on'
        sequence:
          - service: media_player.play_media
            data_template:
              entity_id: '{{ states.input_select.alarma_media_player.state }}'
              media_content_type: sound
              media_content_id: "{{ states('input_select.alarma_sonido_armado') }}"
          - delay: 00:00:03

test_alexa_secuencia_desarmado:
  alias: 'Test Alexa Secuencia Alarma Desrmado'
  mode: restart
  sequence:
    - service: script.alexa_entrada_secuencia
      data_template:
        voz: 'ATENCION!. Sistema desarmado.'
        sonido: "{{ states('input_select.alarma_sonido_desarmado') }}"
        repeticion: 1

test_alexa_anuncio:
  mode: restart
  sequence:
    - service: script.alexa_entrada_set_volumen_alarma
    - service: script.alexa_dormitorio_set_volumen_alarma

    - service: script.alexa_anuncio
      data_template:
        alexa: 'dormitorio'
        voz: 'ATENCION!. Armado Total activado.'

    - service: script.alexa_sonido_alarma
      data_template:
        alexa: 'dormitorio'
        sonido: "{{ states('input_select.alarma_sonido_armado') }}"
        repeticion: 2

    - service: script.alexa_sirena_alarma
      data_template:
        sonido: "{{ states('input_select.alarma_sonido_disparado') }}"

    - service: script.alexa_dormitorio_restaura_volumen

test_media_player_announce:
  alias: 'Alexa Mensaje Voz'
  sequence:
    # envio mensaje voz
    - service: notify.alexa_media
      data_template:
        target: >
          {{ states('input_select.alarma_media_player') }}
        message: >
          {{ states('input_text.mensaje_voz') }}
        data:
          type: announce

test_media_player_secuencia:
  alias: 'Alexa Skill'
  sequence:
    - service: media_player.play_media
      data_template:
        entity_id: >
          {{ states('input_select.alarma_media_player') }}
        media_content_type: sequence
        media_content_id: >
          {{ states('input_select.alexa_secuencia') }}

test_sonido_alarma_desarmado:
  sequence:
    - service: media_player.play_media
      data_template:
        entity_id: >
          {{ states('input_select.alarma_media_player') }}
        media_content_type: sound
        media_content_id: >
          {{ states('input_select.alarma_sonido_desarmado') }}

test_sonido_alarma_armado:
  sequence:
    - service: media_player.play_media
      data_template:
        entity_id: >
          {{ states('input_select.alarma_media_player') }}
        media_content_type: sound
        media_content_id: >
          {{ states('input_select.alarma_sonido_armado') }}

test_sonido_alarma_disparado:
  sequence:
    - service: media_player.play_media
      data_template:
        entity_id: >
          {{ states('input_select.alarma_media_player') }}
        media_content_type: sound
        media_content_id: >
          {{ states('input_select.alarma_sonido_disparado') }}

#-----------------------------------------------------------------------------#
#                                                                             #
# SCRIPTS GENERICOS DE NOTIFICACIONES: IOS, HOMY, TELEGRAM                    #
#                                                                             #
#-----------------------------------------------------------------------------#
notifica_alarma:
  alias: 'Mensaje Alarma'
  sequence:
  # Actualiza el valor de input_text.mensaje_tit con el título recibido.
  - service: input_text.set_value
    entity_id: input_text.mensaje_tit
    data_template:
      value: "{{ titulo }}"

  # Actualiza el valor de input_text.mensaje_msg con el mensaje recibido.
  - service: input_text.set_value
    entity_id: input_text.mensaje_msg
    data_template:
      value: "{{ mensaje }}"

  # Notificación Telegram
  - service: notify.telegram_alarm
    data_template:
      title: >
        {{ states('input_text.mensaje_tit') }}
      message: >
        {{ states('input_text.mensaje_msg') }}
        {{ states('input_text.alarm_trigger') }}

    # Notificación IOS
  - service: notify.notifica_grupo_ios
    data_template:
      title: >
        {{ states('input_text.mensaje_tit') }}
      message: >
        {{ states('input_text.mensaje_msg') }}

  # Notificación Persistente App HOMY
  - service: persistent_notification.create
    data_template:
      title: >
        {{ states('input_text.mensaje_tit') }}
      message: >
        {{ states('input_text.mensaje_msg') }}

  # Notificación Telegram
  #- service: notify.telegram_alarm
  #  data:
  #    titulo: '*ALARMA*'
  #    mensaje: Cámaras Seguridad
  #    data:
  #      photo:
  #        - url: http://192.168.0.13/snapshot/image0.jpg
  #          caption: Cámara Cocina
  #        - url: http://192.168.0.12:8080/snapshot.cgi
  #          caption: Cámara Estudio

notifica_evento:
  alias: 'Notifica Evento'
  sequence:
  # IF HOME_NOTIFY = OFF CANCEL
  - condition: template
    value_template: "{% if not is_state('input_select.home_notify', 'Off') %}true{% endif %}"

  # Actualiza el valor de input_text.mensaje_tit con el título recibido.
  - service: input_text.set_value
    entity_id: input_text.mensaje_tit
    data_template:
      value: "{{ titulo }}"

  # Actualiza el valor de input_text.mensaje_msg con el cuerpo del mensaje recibido.
  - service: input_text.set_value
    entity_id: input_text.mensaje_msg
    data_template:
      value: "{{ mensaje }}"

  # Notificación Telegram
  - service: notify.telegram_notify
    data_template:
      title: >
        {{ states('input_text.mensaje_tit') }}
      message: >
        {{ states('input_text.mensaje_msg') }}

#-----------------------------------------------------------------------------#
#                                                                             #
# CONTROL DE LUCES Y ALUMBRADO                                                #
#                                                                             #
#-----------------------------------------------------------------------------#
luces_dormitorio_lectura:
  alias: 'Luces Dormitorio Lectura'
  sequence:
    # El nombre de la escena es case sensitive
    - service: hue.hue_activate_scene
      data:
        group_name: "Dormitorio"
        scene_name: "Lectura"

luces_dormitorio_relax:
  alias: 'Luces Dormitorio Relax'
  sequence:
    - service: hue.hue_activate_scene
      data:
        group_name: "Dormitorio"
        scene_name: "Relax"

luces_dormitorio_tenue:
  alias: 'Luces Dormitorio Tenue'
  sequence:
    - service: hue.hue_activate_scene
      data:
        group_name: "Dormitorio"
        scene_name: "Tenue"

luces_dormitorio_noche:
  alias: 'Luces Dormitorio Noche'
  sequence:
    - service: hue.hue_activate_scene
      data:
        group_name: "Dormitorio"
        scene_name: "Noche"

luces_salon_relax:
  alias: 'Luces Salon Relax'
  sequence:
    - service: hue.hue_activate_scene
      data:
        group_name: "Salón"
        scene_name: "Relax"

luces_salon_top:
  alias: 'Luces Salon Top'
  sequence:
    - service: hue.hue_activate_scene
      data:
        group_name: "Salón"
        scene_name: "Top"

luces_salon_wpt:
  alias: 'Luces Salon WPT'
  sequence:
    - service: hue.hue_activate_scene
      data:
        group_name: "Salón"
        scene_name: "WPT"

luces_salon_off:
  alias: 'Luces Salon Off'
  sequence:
    - service: light.turn_off
      entity_id: light.salon

luces_estudio_relax:
  alias: 'Luces Estudio Relax'
  sequence:
    - service: hue.hue_activate_scene
      data:
        group_name: "Estudio"
        scene_name: "Relax"

luces_estudio_top:
  alias: 'Luces Estudio Top'
  sequence:
    - service: hue.hue_activate_scene
      data:
        group_name: "Estudio"
        scene_name: "Top"
    - service: light.turn_on
      target:
        entity_id: light.esphome_lb1_l01

luces_estudio_azul:
  alias: 'Luces Estudio Azul'
  sequence:
    - service: hue.hue_activate_scene
      data:
        group_name: "Estudio"
        scene_name: "Azul"
    - service: light.turn_on
      target:
        entity_id: light.esphome_lb1_l01

luces_estudio_off:
  alias: 'Luces Estudio Off'
  sequence:
    - service: light.turn_off
      target:
        area_id: c87f1d973bb247848d28bbe4be4c0a95   # Área Estudio

luz_on_armed_home:
  alias: 'Luces On Entrada si Sensor'
  sequence:
    # When a condition does not return true, the script will finish
    # Check Panel Alarma <> armed_home ==> Exit
    - condition: state
      entity_id: alarm_control_panel.ha
      state: 'armed_home'
    # Enciende Piloto Azul Alarma
    - service: light.turn_on
      entity_id: light.gateway_light_7811dcb788fa
      data:
        brightness: 50
        rgb_color: [0, 0, 254]

luces_on_family_home:
  alias: 'Family at Home Piloto ON'
  sequence:
    #- condition: template
    #  value_template: "{% if is_state('sun.sun', 'below_horizon') %}true{% endif %}"
    - condition: sun
      after: sunset
    - service: light.turn_on
      entity_id: light.luz_entrada

# Apagado Luces Toda La Casa
luces_off:
  alias: 'Luces Off'
  sequence:
    # When a condition does not return true, the script will finish
    - condition: template
      value_template: "{% if is_state('group.luces_casa_grp', 'on') %}true{% endif %}"
    # Apagado Luces Interior Casa
    - service: light.turn_off
      entity_id: group.luces_interior_grp
    # Apagado Luces Exterior
    - service: script.luces_exterior_off

# Apagado Luces Exterior Casa
luces_exterior_off:
  alias: 'Luces Exterior Off'
  sequence:
    # When a condition does not return true, the script will finish
    - condition: template
      value_template: "{% if is_state('group.luces_jardin_grp', 'on') %}true{% endif %}"

    # Apagado Luces Exterior - Switch
    - service: switch.turn_off
      entity_id: group.luces_jardin_grp

    # Apagado Luces Exterior - Light
    - service: light.turn_off
      entity_id: group.luces_jardin_grp

luces_exterior_on:
  alias: 'Luces Exterior y Jardín On'
  sequence:
    # Llamada a scripts de control programador luces diario
    - service: script.luces_jardin_check_xia_ext
    - service: script.luces_jardin_check_bas_sw4
    - service: script.luces_jardin_check_4ch_ch1
    - service: script.luces_jardin_check_4ch_ch2
    - service: script.luces_jardin_check_4ch_ch3

luces_jardin_check_xia_ext:
  alias: 'Luces On Faroles Exterior'
  sequence:
  - condition: state
    entity_id: input_boolean.jardin_programador_xia_ext
    state: 'on'
  - service: light.turn_on
    entity_id: light.sonoff_mini_sw1

luces_jardin_check_bas_sw2:
  alias: 'Luces On Sonoff BAS SW2'
  sequence:
  - condition: state
    entity_id: input_boolean.jardin_programador_bas_sw2
    state: 'on'
  - service: switch.turn_on
    entity_id: switch.jardin_programador_bas_sw2

luces_jardin_check_bas_sw4:
  alias: 'Luces On SonoffBAS SW4'
  sequence:
  - condition: state
    entity_id: input_boolean.jardin_programador_bas_sw4
    state: 'on'
  - service: switch.turn_on
    entity_id: switch.jardin_programador_bas_sw4

luces_jardin_check_4ch_ch1:
  alias: 'Luces On Sonoff4ch CH1'
  sequence:
  - condition: state
    entity_id: input_boolean.jardin_programador_4ch_ch1
    state: 'on'
  - service: switch.turn_on
    entity_id: switch.esphome_4ch_relay_1

luces_jardin_check_4ch_ch2:
  alias: 'Luces On Sonoff4ch CH2'
  sequence:
  - condition: state
    entity_id: input_boolean.jardin_programador_4ch_ch2
    state: 'on'
  - service: switch.turn_on
    entity_id: switch.esphome_4ch_relay_2

luces_jardin_check_4ch_ch3:
  alias: 'Luces On Sonoff4ch CH3'
  sequence:
  - condition: state
    entity_id: input_boolean.jardin_programador_4ch_ch3
    state: 'on'
  - service: switch.turn_on
    entity_id: switch.esphome_4ch_relay_3


#-----------------------------------------------------------------------------#
#                                                                             #
# SCRIPTS DE DEPURADORA PISCINA                                               #
#                                                                             #
#-----------------------------------------------------------------------------#

piscina_timer_start:
  alias: Timer Piscina Start
  sequence:
    - service: timer.start
      data_template:
        entity_id: timer.piscina
        duration: '{{ states.sensor.piscina_manual_segundos.state}}'
    - service: switch.turn_on
      entity_id: switch.esphome_pow_sw3
    # Actualiza Valor Hora Arranque Real
    - service: input_datetime.set_datetime
      entity_id: input_datetime.piscina_real_start_time
      data_template:
        time: '{{ (as_timestamp(now()) | timestamp_custom("%H:%M:%S")) }}'
    # Actualiza Valor Duración Programa Activo
    - service: input_text.set_value
      entity_id: input_text.piscina_duracion_programa
      data_template:
        value: '{{ states.sensor.piscina_duracion_manual.state}}'

piscina_timer_start_diario:
  alias: Timer Piscina Start
  sequence:
    - service: timer.start
      data_template:
        entity_id: timer.piscina
        duration: '{{ states.sensor.piscina_duracion_planificada.state}}'
    - service: switch.turn_on
      entity_id: switch.esphome_pow_sw3
    # Actualiza Valor Hora Arranque Real
    - service: input_datetime.set_datetime
      entity_id: input_datetime.piscina_real_start_time
      data_template:
        time: '{{ (as_timestamp(now()) | timestamp_custom("%H:%M:%S")) }}'
    # Actualiza Valor Duración Programa Activo
    - service: input_text.set_value
      entity_id: input_text.piscina_duracion_programa
      data_template:
        value: '{{ states.sensor.piscina_duracion_planificada.state}}'

piscina_timer_cancel:
  alias: Timer Piscina Cancel
  sequence:
    - service: timer.cancel
      entity_id: timer.piscina
    - service: switch.turn_off
      entity_id: switch.esphome_pow_sw3
      #entity_id: switch.esphome_4ch_relay_2
    # Actualiza Valor Hora Arranque Real
    - service: input_datetime.set_datetime
      entity_id: input_datetime.piscina_real_end_time
      data_template:
        time: '{{ (as_timestamp(now()) | timestamp_custom("%H:%M:%S")) }}'
    # Actualiza Valor Duración Programa Activo
    - service: input_text.set_value
      entity_id: input_text.piscina_duracion_programa
      data_template:
        value: ''

piscina_timer_pause:
  alias: Timer Piscina Pause
  sequence:
    - service: timer.pause
      entity_id: timer.piscina
    - service: switch.turn_off
      entity_id: switch.esphome_pow_sw3

piscina_timer_resume:
  alias: Timer Piscina Resume
  sequence:
    - service: timer.start
      entity_id: timer.piscina
    - service: switch.turn_on
      entity_id: switch.esphome_pow_sw3

riego_ch1_timer_cancel:
  alias: Timer Riego CH1 Cancel
  sequence:
    - service: timer.cancel
      entity_id: timer.riego_ch1
    - service: switch.turn_off
      entity_id: switch.esphome_4ch_sw2_relay_1

riego_ch2_timer_cancel:
  alias: Timer Riego CH2 Cancel
  sequence:
    - service: timer.cancel
      entity_id: timer.riego_ch2
    - service: switch.turn_off
      entity_id: switch.esphome_4ch_sw2_relay_2

riego_ch3_timer_cancel:
  alias: Timer Riego CH3 Cancel
  sequence:
    - service: timer.cancel
      entity_id: timer.riego_ch3
    - service: switch.turn_off
      entity_id: switch.esphome_4ch_sw2_relay_3

riego_ch4_timer_cancel:
  alias: Timer Riego CH3 Cancel
  sequence:
    - service: timer.cancel
      entity_id: timer.riego_ch4
    - service: switch.turn_off
      entity_id: switch.esphome_4ch_sw2_relay_4

riego_sw2_timer_cancel:
  alias: Timer Bonsais SW2 Cancel
  sequence:
    - service: timer.cancel
      entity_id: timer.riego_bonsais
    - service: switch.turn_off
      entity_id: switch.esphome_bas_sw2

riego_tomates_timer_cancel:
  alias: Timer Tomatera Cancel
  sequence:
    - service: timer.cancel
      entity_id: timer.riego_tomates
    - service: switch.turn_off
      entity_id: switch.esphome_pow_sw1

#-----------------------------------------------------------------------------#
#                                                                             #
# SCRIPTS DE RIEGO BONSAIS SONOFF 4CH-SW2 CH1 - CH4                           #
#                                                                             #
#-----------------------------------------------------------------------------#
#riego_ch1_timer_start_diario:
#  alias: Timer Riego CH1 Start Automatico
#  sequence:
#    - service: timer.start
#      data_template:
#        entity_id: timer.riego_ch1
#        duration: '{{ states.sensor.riego_ch1_duracion_planificada.state}}'
#    - service: switch.turn_on
#      entity_id: switch.esphome_4ch_sw2_relay_1


#-----------------------------------------------------------------------------#
#                                                                             #
# SCRIPTS DE INTERRUPTORES SONOFF                                             #
#                                                                             #
#-----------------------------------------------------------------------------#

#Apagado SW Sonoff Jardín
jardin_off:
  alias: 'Jardin Off'
  sequence:
    # When a condition does not return true, the script will finish
    # Apagado Depuradora Piscina
    - service: switch.turn_off
      entity_id: switch.esphome_pow_sw3
    # Apagado Riego Jardin y Fuentes
    - service: switch.turn_off
      entity_id: switch.esphome_4ch_sw2_relay_1
    - service: switch.turn_off
      entity_id: switch.esphome_4ch_sw2_relay_2
    - service: switch.turn_off
      entity_id: switch.esphome_4ch_sw2_relay_3

# SONOFF S20 - NESSPRESSO
#
#nesspreso_on_timer:
#  alias: Nespresso On Timer
#  sequence:
#    - service: automation.turn_off
#      entity_id: automation.S10_esphome_s20_Sunrise_Switch_On
#    # Incremento del contador de autoencendido
#    - service: counter.increment
#      entity_id: counter.nespresso_start
#    # Enciende la Nespresso
#    - service: switch.turn_on
#      entity_id: switch.esphome_s20_nespresso
#    # Notifica Evento
#    - service: script.turn_on
#      entity_id: script.notifica_evento
#      data:
#        titulo: '*HOMY: BUENOS DIAS*'
#        mensaje: >
#            >>> Nespresso auto-encendida al amanecer.
#            >>> Por favor, apáguela al terminar.
#
#    - delay: '00:30:00'
#   - service: automation.turn_on
#      entity_id: automation.S10_esphome_s20_Sunrise_Switch_On

# SONOFF S20 - CALEFACCION
#
#calefaccion_mfc_on:
#  alias: Calefacción On Dormitorio MFC
#  sequence:
    # Si el interruptor duerme en casa está On continua
    #- condition: template
    #  value_template: "{% if is_state('input_boolean.calefac_programador_mfc', 'on') and
    #                         (is_state('input_boolean.family_sleep_home_mfc', 'on') or is_state('input_boolean.family_sleep_home_aac', 'on'))
    #                          %}true{% else %}false{% endif %}"
    #
#    - service: switch.turn_on
#      entity_id: switch.esphome_s20_sw1


# SONOFF POW R2 - LAVADORA
#
lavadora_switch_off:
  alias: Lavadora Switch Off
  sequence:
    - delay: 00:00:05

    - condition: template
      value_template: '{{ as_timestamp(states.binary_sensor.esphome_pow_sw2_lavadora_warning.last_changed) - as_timestamp(states.binary_sensor.esphome_pow_sw2_lavadora_lavando.last_changed) < 300 }}'

    - service: switch.turn_off
      entity_id: switch.esphome_pow_sw2

    # Si la diferencia de hora ultimo cambio entre Warning y Lavando < 5' => TRUE => CONTINUA
    #
    # WARNING:
    #  2019-05-26 10:21:08.137265+00:00
    #  1558866068.137265
    #
    # LAVANDO:
    #  2019-05-26 10:20:52.612011+00:00
    #  1558866052.612011
    #
    # DIF:
    #  15.525254011154175
    #  TRUE

    # WARNING:
    # {{ states.binary_sensor.esphome_pow_sw2_lavadora_warning.last_changed }}
    # {{ as_timestamp(states.binary_sensor.esphome_pow_sw2_lavadora_warning.last_changed) }}
    #
    # LAVANDO:
    # {{ states.binary_sensor.esphome_pow_sw2_lavadora_lavando.last_changed }}
    # {{ as_timestamp(states.binary_sensor.esphome_pow_sw2_lavadora_lavando.last_changed) }}
    #
    # DIF:
    # {{ as_timestamp(states.binary_sensor.esphome_pow_sw2_lavadora_warning.last_changed) - as_timestamp(states.binary_sensor.esphome_pow_sw2_lavadora_lavando.last_changed) }}
    #
    # {{ as_timestamp(states.binary_sensor.esphome_pow_sw2_lavadora_warning.last_changed) - as_timestamp(states.binary_sensor.esphome_pow_sw2_lavadora_lavando.last_changed) < 300 }}


#-----------------------------------------------------------------------------#
#                                                                             #
# SCRIPTS DE ARRANQUE DEL SISTEMA                                             #
#                                                                             #
#-----------------------------------------------------------------------------#
sonoff_initialize:
  alias: 'Arranque Interruptores SONOFF'
  sequence:
    #
    # SONOFF_BAS_SW1_SIRENA INTERIOR ==> OFF
    - service: switch.turn_off
      entity_id: switch.esphome_bas_sw0

    #
    #- service: switch.turn_on
    # SONOFF_POW_SW2_LAVADORA => ON
    #  entity_id: switch.esphome_pow_sw2

#-----------------------------------------------------------------------------#
#                                                                             #
# SISTEMA DE CAMARAS BLINK                                                    #
#                                                                             #
#-----------------------------------------------------------------------------#
blink_trigger_cam_hall:
  alias: 'Blink Trigger Camera Entrada'
  sequence:
    - service: blink.trigger_camera
      data:
        entity_id: camera.blink_hall
    - delay: 00:00:05
    - service: blink.blink_update
    - service: camera.snapshot
      data:
        entity_id: camera.blink_hall
        filename: /share/blink_hall.jpg

blink_trigger_cam_puerta_principal:
  alias: 'Blink Trigger Camera Puerta'
  sequence:
    - service: blink.trigger_camera
      data:
        entity_id: camera.blink_puerta_principal
    - delay: 00:00:05
    - service: blink.blink_update
    - service: camera.snapshot
      data:
        entity_id: camera.blink_puerta_principal
        filename: /share/blink_puerta.jpg

blink_trigger_cam_puerta_garaje:
  alias: 'Blink Trigger Camera Garaje'
  sequence:
    - service: blink.trigger_camera
      data:
        entity_id: camera.blink_puerta_garaje
    - delay: 00:00:05
    - service: blink.blink_update
    - service: camera.snapshot
      data:
        entity_id: camera.blink_puerta_garaje
        filename: /share/blink_garaje.jpg

blink_trigger_cam_piscina:
  alias: 'Blink Trigger Camera Piscina'
  sequence:
    - service: blink.trigger_camera
      data:
        entity_id: camera.blink_piscina
    - delay: 00:00:05
    - service: blink.blink_update
    - service: camera.snapshot
      data:
        entity_id: camera.blink_piscina
        filename: /share/blink_piscina.jpg


